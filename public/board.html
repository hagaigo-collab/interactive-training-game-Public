<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>לוח תצוגה – משחק הדרכה</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="question" id="question-display">אין שאלה עדיין…</div>

    <div id="board" class="board" aria-label="לוח תשובות"></div>

    <div class="form" style="position:fixed;bottom:10px;right:10px;gap:5px;width:auto">
      <input id="room" class="input" placeholder="קוד חדר" style="width:100px"/>
      <button id="join" class="button">קישור</button>
      <button id="export-png" class="button secondary">ייצוא PNG</button>
    </div>
  </div>

  <script>
    (function(){
      const board = document.getElementById('board');
      let ROOM = new URL(location.href).searchParams.get('room') || '';
      let socket, Z = 1;

      function ensureIoLoaded() {
        return new Promise((resolve) => {
          if (typeof io !== 'undefined') return resolve();
          const s = document.createElement('script');
          s.src = 'https://cdn.socket.io/4.7.5/socket.io.min.js';
          s.onload = () => resolve();
          s.onerror = () => resolve();
          document.head.appendChild(s);
        });
      }

      function createCard(it, prefs){
        const el = document.createElement('div');
        el.className = 'card' + (it.kind === 'title' ? ' title' : '');
        el.id = 'item-' + it.id;
        el.style.left = (it.x||0) + 'px';
        el.style.top  = (it.y||0) + 'px';
        el.style.width  = (it.width||280) + 'px';
        el.style.height = (it.height||100) + 'px';
        el.style.zIndex = it.z || 1;
        if (it.bg) el.style.background = it.bg;
        if (it.color) el.style.color = it.color;
        if (it.borderColor) el.style.borderColor = it.borderColor;

        if (it.kind === 'answer' && prefs?.showNamesOnBoard) {
          const name = document.createElement('div');
          name.className = 'name';
          name.textContent = it.name || '';
          el.appendChild(name);
        }

        const p = document.createElement('p');
        p.textContent = it.text || '';
        el.appendChild(p);

        enableDragResize(el, it.id);
        board.appendChild(el);
      }

      function clearCards(){ board.innerHTML = ''; }

      function enableDragResize(el, id){
        let dragging=false, resizing=false, sx=0, sy=0, ox=0, oy=0, ow=0, oh=0;
        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        el.appendChild(handle);

        el.addEventListener('pointerdown', (e)=>{
          if (e.target === handle) {
            resizing = true;
            el.setPointerCapture(e.pointerId);
            sx=e.clientX; sy=e.clientY;
            ow=parseInt(el.style.width)||280;
            oh=parseInt(el.style.height)||100;
          } else {
            dragging=true;
            el.setPointerCapture(e.pointerId);
            sx=e.clientX; sy=e.clientY;
            ox=parseInt(el.style.left)||0;
            oy=parseInt(el.style.top)||0;
            el.style.zIndex=(++Z)+'';
          }
        });
        el.addEventListener('pointermove', (e)=>{
          if(dragging){
            const dx=e.clientX-sx, dy=e.clientY-sy;
            el.style.left=(ox+dx)+'px';
            el.style.top=(oy+dy)+'px';
          }
          if(resizing){
            const dx=e.clientX-sx, dy=e.clientY-sy;
            el.style.width=(Math.max(200,ow+dx))+'px';
            el.style.height=(Math.max(64,oh+dy))+'px';
          }
        });
        el.addEventListener('pointerup', (e)=>{
          if(dragging){
            dragging=false;
            const x=parseInt(el.style.left)||0, y=parseInt(el.style.top)||0;
            socket.emit('moveItem', { room: ROOM, id, x, y });
          }
          if(resizing){
            resizing=false;
            const width=parseInt(el.style.width)||280, height=parseInt(el.style.height)||100;
            socket.emit('resizeItem', { room: ROOM, id, width, height });
          }
        });
      }

      async function joinRoom(room){
        ROOM = room.trim().toUpperCase();
        if (!ROOM) return alert('נא להזין קוד חדר');
        await ensureIoLoaded();
        socket = io();
        socket.emit('joinRoom', { room: ROOM, role: 'board' });

        socket.on('state', ({ question, items, style, prefs }) => {
          document.getElementById('question-display').textContent = question || 'אין שאלה עדיין…';
          clearCards(); (items||[]).forEach(it => createCard(it, prefs));
          if (style) board.style.background = style.boardBg;
        });

        socket.on('question', (q) => {
          document.getElementById('question-display').textContent = q || 'אין שאלה עדיין…';
        });
        socket.on('clearItems', clearCards);
        socket.on('newItem', (it)=>createCard(it));
        socket.on('moveItem', ({id,x,y,z})=>{
          const el=document.getElementById('item-'+id);
          if(el){ el.style.left=x+'px'; el.style.top=y+'px'; el.style.zIndex=z; }
        });
        socket.on('resizeItem', ({id,width,height})=>{
          const el=document.getElementById('item-'+id);
          if(el){ el.style.width=width+'px'; el.style.height=height+'px'; }
        });
        socket.on('roomStyle', (style)=>{
          if (style) board.style.background = style.boardBg;
        });
        socket.on('boardPrefs', (prefs)=>{
          // הסתר/הצג שמות לפי העדפת המנחה
          document.querySelectorAll('.card.answer .name').forEach(nameEl=>{
            nameEl.style.display = prefs.showNamesOnBoard ? '' : 'none';
          });
        });
      }

      document.getElementById('join').addEventListener('click', ()=>{
        const r = document.getElementById('room').value;
        joinRoom(r);
      });

      document.getElementById('export-png').addEventListener('click', async function(){
        if (!ROOM) return alert('לא מחוברים לחדר');
        const node = document.getElementById('board');
        const q = document.getElementById('question-display').textContent.trim();
        const bg = getComputedStyle(board).backgroundColor;
        const canvas = await html2canvas(node, { backgroundColor: bg, scale: 3 });
        const link = document.createElement('a');
        let name = 'board_' + ROOM + '_' + Date.now() + (q ? '_' + q.slice(0,30) : '') + '.png';
        name = name.split(' ').join('_');
        link.download = name;
        link.href = canvas.toDataURL('image/png');
        link.click();
      });

      // אם נכנסו עם room בפרמטר
      (function init(){
        const fromUrl = new URL(location.href).searchParams.get('room');
        if(fromUrl){
          document.getElementById('room').value = fromUrl;
          joinRoom(fromUrl);
        }
      })();
    })();
  </script>
</body>
</html>

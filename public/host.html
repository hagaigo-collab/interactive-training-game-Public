<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מסך מנחה – משחק הדרכה</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 style="margin:0">מסך מנחה</h2>
      <span class="meta">חדר: <span id="room-pill" class="pill">—</span></span>
      <span class="meta copy-link">
        <button id="copy-btn" class="button ghost">העתק קישור למשתתפים</button>
        <button id="copy-board-btn" class="button ghost">קישור ללוח התצוגה</button>
        <span class="small" id="join-url"></span>
      </span>
    </div>

    <div class="form">
      <label for="question">שאלה להצגה:</label>
      <input id="question" class="input" placeholder="כתבו כאן את השאלה" />
      <button id="send-question" class="button">שלח שאלה</button>
      <button id="export-png" class="button secondary">ייצוא PNG של הלוח</button>
      <button id="new-room" class="button secondary">חדר חדש</button>
    </div>

    <!-- כותרות של המנחה -->
    <div class="form" style="grid-template-columns: 1fr 2fr auto; margin-top:10px">
      <label for="titleText">הוסף כותרת ללוח:</label>
      <input id="titleText" class="input" placeholder="טקסט כותרת (למשל: רעיונות מרכזיים)" />
      <button id="add-title" class="button">הוסף כותרת</button>
    </div>

    <!-- בוחרי צבעים והעדפות -->
    <div class="form" style="grid-template-columns: auto auto auto auto; margin-top:10px">
      <label>צבע רקע לוח <input type="color" id="boardBg" value="#ffffff"></label>
      <label>צבע כותרת <input type="color" id="titleBg" value="#FFEB3B"></label>
      <label>צבע טקסט כותרת <input type="color" id="titleColor" value="#000000"></label>
      <label><input type="checkbox" id="toggle-names" checked> הצג שמות בלוח</label>
    </div>

    <div class="question" id="question-display">אין שאלה עדיין…</div>

    <div>
      <div id="board" class="board" aria-label="לוח תשובות"></div>
      <p class="small">גררו מלבנים עם העכבר או שנו את גודלם. שליחת שאלה חדשה מאפסת את הלוח.</p>
    </div>
  </div>

  <script>
    (function(){
      const board     = document.getElementById('board');
      const roomPill  = document.getElementById('room-pill');
      const joinUrlEl = document.getElementById('join-url');
      const copyBtn   = document.getElementById('copy-btn');
      const copyBoardBtn = document.getElementById('copy-board-btn');

      const boardBgInput  = document.getElementById('boardBg');
      const titleBgInput  = document.getElementById('titleBg');
      const titleClrInput = document.getElementById('titleColor');
      const toggleNamesEl = document.getElementById('toggle-names');

      let ROOM = new URL(location.href).searchParams.get('room') || '';
      if (ROOM) {
        roomPill.textContent = ROOM;
        joinUrlEl.textContent = location.origin + '/join.html?room=' + encodeURIComponent(ROOM);
      }

      function ensureIoLoaded() {
        return new Promise((resolve) => {
          if (typeof io !== 'undefined') return resolve();
          const s = document.createElement('script');
          s.src = 'https://cdn.socket.io/4.7.5/socket.io.min.js';
          s.onload = () => resolve();
          s.onerror = () => resolve();
          document.head.appendChild(s);
        });
      }

      async function ensureRoom() {
        if (ROOM) return ROOM;
        const res = await fetch('/api/new-room', { cache: 'no-store' });
        const data = await res.json();
        ROOM = data.room;
        const url = new URL(window.location.href);
        url.searchParams.set('room', ROOM);
        history.replaceState({}, '', url);
        roomPill.textContent = ROOM;
        joinUrlEl.textContent = location.origin + '/join.html?room=' + encodeURIComponent(ROOM);
        return ROOM;
      }

      function participantLink(room){
        return location.origin + '/join.html?room=' + encodeURIComponent(room);
      }
      function boardLink(room){
        return location.origin + '/board.html?room=' + encodeURIComponent(room);
      }

      let socket, Z = 1;

      function applyTitleStyleToDom(style){
        // עדכון כל הכותרות הקיימות לפי הסטייל הנוכחי
        const titles = document.querySelectorAll('.card.title');
        titles.forEach(el => {
          if (style.titleBg) el.style.background = style.titleBg;
          if (style.titleColor) el.style.color = style.titleColor;
        });
      }

      function createCard(it){
        const el = document.createElement('div');
        el.className = 'card' + (it.kind === 'title' ? ' title' : '');
        el.id = 'item-' + it.id;
        el.style.left = (it.x||0) + 'px';
        el.style.top  = (it.y||0) + 'px';
        el.style.width  = (it.width||280) + 'px';
        el.style.height = (it.height||100) + 'px';
        el.style.zIndex = it.z || 1;

        // צבעים לפי מה שמגיע מהשרת
        if (it.bg)    el.style.background = it.bg;
        if (it.color) el.style.color      = it.color;
        if (it.borderColor) el.style.borderColor = it.borderColor;

        if (it.kind === 'answer') {
          const name = document.createElement('div');
          name.className = 'name';
          name.textContent = it.name || '';
          el.appendChild(name);
        }

        const p = document.createElement('p');
        p.textContent = it.text || '';
        el.appendChild(p);

        enableDragResize(el, it.id);
        board.appendChild(el);
      }

      function clearCards(){ board.innerHTML = ''; }

      function enableDragResize(el, id){
        let dragging=false, resizing=false, sx=0, sy=0, ox=0, oy=0, ow=0, oh=0;
        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        el.appendChild(handle);

        el.addEventListener('pointerdown', (e)=>{
          if (e.target === handle) {
            resizing = true;
            el.setPointerCapture(e.pointerId);
            sx=e.clientX; sy=e.clientY;
            ow=parseInt(el.style.width)||280;
            oh=parseInt(el.style.height)||100;
          } else {
            dragging=true;
            el.setPointerCapture(e.pointerId);
            sx=e.clientX; sy=e.clientY;
            ox=parseInt(el.style.left)||0;
            oy=parseInt(el.style.top)||0;
            el.style.zIndex=(++Z)+'';
          }
        });
        el.addEventListener('pointermove', (e)=>{
          if(dragging){
            const dx=e.clientX-sx, dy=e.clientY-sy;
            el.style.left=(ox+dx)+'px';
            el.style.top=(oy+dy)+'px';
          }
          if(resizing){
            const dx=e.clientX-sx, dy=e.clientY-sy;
            el.style.width=(Math.max(200,ow+dx))+'px';
            el.style.height=(Math.max(64,oh+dy))+'px';
          }
        });
        el.addEventListener('pointerup', (e)=>{
          if(dragging){
            dragging=false;
            const x=parseInt(el.style.left)||0, y=parseInt(el.style.top)||0;
            socket.emit('moveItem', { room: ROOM, id, x, y });
          }
          if(resizing){
            resizing=false;
            const width=parseInt(el.style.width)||280, height=parseInt(el.style.height)||100;
            socket.emit('resizeItem', { room: ROOM, id, width, height });
          }
        });
      }

      (async function init(){
        await ensureIoLoaded();
        await ensureRoom();

        socket = io();
        socket.emit('joinRoom', { room: ROOM, role: 'host' });

        // שליחה/הוספה
        document.getElementById('send-question').addEventListener('click', function(){
          const q = document.getElementById('question').value.trim();
          socket.emit('setQuestion', { room: ROOM, question: q });
          document.getElementById('question').value = '';
        });

        document.getElementById('add-title').addEventListener('click', function(){
          const t = document.getElementById('titleText').value.trim();
          if (!t) return;
          socket.emit('addTitle', { room: ROOM, text: t });
          document.getElementById('titleText').value = '';
        });

        // יצירת חדר חדש
        document.getElementById('new-room').addEventListener('click', async function(){
          document.getElementById('question-display').textContent = 'אין שאלה עדיין…';
          clearCards();
          try {
            const res = await fetch('/api/new-room', { cache: 'no-store' });
            const data = await res.json();
            const url  = new URL(window.location.href);
            url.searchParams.set('room', data.room);
            window.location.replace(url.toString());
          } catch (e) {
            alert('לא הצלחתי ליצור חדר חדש. נסה שוב.');
          }
        });

        // העתקים
        copyBtn.addEventListener('click', async function(){
          try {
            await navigator.clipboard.writeText(participantLink(ROOM));
            copyBtn.textContent = 'הועתק!';
            setTimeout(()=> copyBtn.textContent = 'העתק קישור למשתתפים', 1200);
          } catch (e) {}
        });
        copyBoardBtn.addEventListener('click', async function(){
          try {
            await navigator.clipboard.writeText(boardLink(ROOM));
            copyBoardBtn.textContent = 'הועתק!';
            setTimeout(()=> copyBoardBtn.textContent = 'קישור ללוח התצוגה', 1200);
          } catch (e) {}
        });

        // יצוא PNG
        document.getElementById('export-png').addEventListener('click', async function(){
          const node = document.getElementById('board');
          const q = document.getElementById('question-display').textContent.trim();
          const bg = getComputedStyle(board).backgroundColor;
          const canvas = await html2canvas(node, { backgroundColor: bg, scale: 3 });
          const link = document.createElement('a');
          let name = 'board_' + ROOM + '_' + Date.now() + (q ? '_' + q.slice(0,30) : '') + '.png';
          name = name.split(' ').join('_');
          link.download = name;
          link.href = canvas.toDataURL('image/png');
          link.click();
        });

        // שינוי צבעים/העדפות – שליחה לשרת
        boardBgInput.addEventListener('input', (e)=>{
          socket.emit('setRoomStyle', { room: ROOM, style: { boardBg: e.target.value } });
        });
        titleBgInput.addEventListener('input', (e)=>{
          socket.emit('setRoomStyle', { room: ROOM, style: { titleBg: e.target.value } });
        });
        titleClrInput.addEventListener('input', (e)=>{
          socket.emit('setRoomStyle', { room: ROOM, style: { titleColor: e.target.value } });
        });
        toggleNamesEl.addEventListener('change', (e)=>{
          socket.emit('setBoardPrefs', { room: ROOM, prefs: { showNamesOnBoard: e.target.checked } });
        });

        // קבלת מצב התחלתי
        socket.on('state', ({ question, items, style, prefs }) => {
          document.getElementById('question-display').textContent = question || 'אין שאלה עדיין…';
          clearCards(); (items||[]).forEach(createCard);

          if (style) {
            board.style.background = style.boardBg;
            // לסנכרן את הערכים בבוחרי הצבע
            if (style.boardBg)  boardBgInput.value  = style.boardBg;
            if (style.titleBg)  titleBgInput.value  = style.titleBg;
            if (style.titleColor) titleClrInput.value = style.titleColor;
            // לעדכן כותרות קיימות לפי הסטייל
            applyTitleStyleToDom(style);
          }
          if (prefs) {
            toggleNamesEl.checked = !!prefs.showNamesOnBoard;
          }
        });

        socket.on('question', (q) => {
          document.getElementById('question-display').textContent = q || 'אין שאלה עדיין…';
        });

        socket.on('clearItems', clearCards);
        socket.on('newItem', (it) => createCard(it));
        socket.on('moveItem', ({id,x,y,z}) => {
          const el = document.getElementById('item-'+id);
          if (el) { el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.zIndex=z; }
        });
        socket.on('resizeItem', ({id,width,height})=>{
          const el = document.getElementById('item-'+id);
          if (el) { el.style.width = width+'px'; el.style.height = height+'px'; }
        });

        // סגנון חדר – החלה גם על כותרות קיימות + סנכרון קלטים
        socket.on('roomStyle', (style)=>{
          if (!style) return;
          if (style.boardBg)  board.style.background = style.boardBg;
          if (style.boardBg)  boardBgInput.value  = style.boardBg;
          if (style.titleBg)  titleBgInput.value  = style.titleBg;
          if (style.titleColor) titleClrInput.value = style.titleColor;
          applyTitleStyleToDom(style);
        });

        // העדפת שמות – לעדכן את המתג אם השתנה מרחוק
        socket.on('boardPrefs', (prefs)=>{
          if (!prefs) return;
          toggleNamesEl.checked = !!prefs.showNamesOnBoard;
        });
      })();
    })();
  </script>
</body>
</html>
